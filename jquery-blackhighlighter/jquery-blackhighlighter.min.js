"use strict";(function(e){if(typeof define==="function"&&define.amd){define(["jquery"],e)}else{e(jQuery)}})(function(e){function n(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:e===43?62:e===47?63:0}function r(e,t){var r=e.replace(/[^A-Za-z0-9\+\/]/g,""),i=r.length,s=t?Math.ceil((i*3+1>>2)/t)*t:i*3+1>>2,o=new Uint8Array(s);for(var u,a,f=0,l=0,c=0;c<i;c++){a=c&3;f|=n(r.charCodeAt(c))<<18-6*a;if(a===3||i-c===1){for(u=0;u<3&&l<s;u++,l++){o[l]=f>>>(16>>>u&24)&255}f=0}}return o}function i(e){return e<26?e+65:e<52?e+71:e<62?e-4:e===62?43:e===63?47:65}function s(e){var t=2,n="";for(var r=e.length,s=0,o=0;o<r;o++){t=o%3;if(o>0&&o*4/3%76===0){n+="\r\n"}s|=e[o]<<(16>>>t&24);if(t===2||e.length-o===1){n+=String.fromCharCode(i(s>>>18&63),i(s>>>12&63),i(s>>>6&63),i(s&63));s=0}}return n.substr(0,n.length-2+t)+(t===2?"":t===1?"=":"==")}function o(e){var t="";for(var n,r=e.length,i=0;i<r;i++){n=e[i];t+=String.fromCharCode(n>251&&n<254&&i+5<r?(n-252)*1073741824+(e[++i]-128<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>247&&n<252&&i+4<r?(n-248<<24)+(e[++i]-128<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>239&&n<248&&i+3<r?(n-240<<18)+(e[++i]-128<<12)+(e[++i]-128<<6)+e[++i]-128:n>223&&n<240&&i+2<r?(n-224<<12)+(e[++i]-128<<6)+e[++i]-128:n>191&&n<224&&i+1<r?(n-192<<6)+e[++i]-128:n)}return t}function u(e){var t,n,r=e.length,i=0;for(var s=0;s<r;s++){n=e.charCodeAt(s);i+=n<128?1:n<2048?2:n<65536?3:n<2097152?4:n<67108864?5:6}t=new Uint8Array(i);for(var o=0,u=0;o<i;u++){n=e.charCodeAt(u);if(n<128){t[o++]=n}else if(n<2048){t[o++]=192+(n>>>6);t[o++]=128+(n&63)}else if(n<65536){t[o++]=224+(n>>>12);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else if(n<2097152){t[o++]=240+(n>>>18);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else if(n<67108864){t[o++]=248+(n>>>24);t[o++]=128+(n>>>18&63);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}else{t[o++]=252+n/1073741824;t[o++]=128+(n>>>24&63);t[o++]=128+(n>>>18&63);t[o++]=128+(n>>>12&63);t[o++]=128+(n>>>6&63);t[o++]=128+(n&63)}}return t}function f(e,t){var n=(e&65535)+(t&65535);var r=(e>>16)+(t>>16)+(n>>16);return r<<16|n&65535}function l(e,t){return e>>>t|e<<32-t}function c(e,t){return e>>>t}function h(e,t,n){return e&t^~e&n}function p(e,t,n){return e&t^e&n^t&n}function d(e){return l(e,2)^l(e,13)^l(e,22)}function v(e){return l(e,6)^l(e,11)^l(e,25)}function m(e){return l(e,7)^l(e,18)^c(e,3)}function g(e){return l(e,17)^l(e,19)^c(e,10)}function y(e,t){var n=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298);var r=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225);var i=new Array(64);var s,o,u,a,l,c,y,b,w,E;var S,x;e[t>>5]|=128<<24-t%32;e[(t+64>>9<<4)+15]=t;for(var w=0;w<e.length;w+=16){s=r[0];o=r[1];u=r[2];a=r[3];l=r[4];c=r[5];y=r[6];b=r[7];for(var E=0;E<64;E++){if(E<16)i[E]=e[E+w];else i[E]=f(f(f(g(i[E-2]),i[E-7]),m(i[E-15])),i[E-16]);S=f(f(f(f(b,v(l)),h(l,c,y)),n[E]),i[E]);x=f(d(s),p(s,o,u));b=y;y=c;c=l;l=f(a,S);a=u;u=o;o=s;s=f(S,x)}r[0]=f(s,r[0]);r[1]=f(o,r[1]);r[2]=f(u,r[2]);r[3]=f(a,r[3]);r[4]=f(l,r[4]);r[5]=f(c,r[5]);r[6]=f(y,r[6]);r[7]=f(b,r[7])}return r}function b(e){var t=Array();var n=(1<<a)-1;for(var r=0;r<e.length*a;r+=a)t[r>>5]|=(e.charCodeAt(r/a)&n)<<24-r%32;return t}function w(e){var t=0;var n=t?"0123456789ABCDEF":"0123456789abcdef";var r="";for(var i=0;i<e.length*4;i++){r+=n.charAt(e[i>>2]>>(3-i%4)*8+4&15)+n.charAt(e[i>>2]>>(3-i%4)*8&15)}return r}function E(e){return w(y(b(e),e.length*a))}function x(e){return String(e).replace(/[&<>"'\/]/g,function(e){return S[e]})}function k(e){if(window.console&&console.warn)console.warn(e)}var t=null;var a=8;var S={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};var T={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};var N={makeCommitUrl:function(e){return e+"commit/"},makeVerifyUrl:function(e,t){return e+"verify/"+t},makeShowUrl:function(e,t){return e+"show/"+t},makeRevealUrl:function(e){return e+"reveal/"},generateRandomUUID:function(){function e(e){if(e===0){return""}var t="";for(var n=0;n<(e?e:1);n++){t+=((1+Math.random())*65536|0).toString(16).substring(1)}return t}return e(2)+"-"+e()+"-"+e()+"-"+e()+"-"+e(3)},stripHyphensFromUUID:function(e){return e.replace(/-/g,"")},isWhitespace:function(e){var t=" 	\n\r\f ";return t.indexOf(e)!=-1},escapeNonBreakingSpacesInString:function(e){var t=e.split(" ");if(t.length==1){return e}var n=t[0];for(var r=1;r<t.length;r++){n+="\\"+"u00A0";n+=t[r]}return n},trimLeadingWhitespace:function(e){var t=0;while(t<e.length&&this.isWhitespace(e.charAt(t))){t++}return e.substring(t,e.length)},trimTrailingWhitespace:function(e){var t=e.length-1;while(t>=0&&this.isWhitespace(e.charAt(t))){t--}return e.substring(0,t+1)},trimAllWhitespace:function(e){return this.trimLeadingWhitespace(this.trimTrailingWhitespace(e))},canonicalJsonFromCommit:function(e){var t='{"commit_date":';t+=JSON.stringify(e.commit_date);t+=",";var n=true;t+='"spans":[';for(var r=0;r<e.spans.length;r++){var i=e.spans[r];if(n){n=false}else{t+=","}if(typeof i=="string"||i instanceof String){t+=JSON.stringify(i)}else{t+='["display_length":';t+=i.display_length.toString(10);t+=",";t+='"sha256":';t+=JSON.stringify(i.sha256);t+="]"}}t+="]}";return t},canonicalStringFromReveal:function(e){var t=e.salt;for(var n=0;n<e.redactions.length;n++){var r=e.redactions[n];t+=r}return t}};if(e.isFakeJquery){return N}var C=function(e,t){C._registry.push(this);this.$div=e;e.addClass("blackhighlighter");this.setMode(t.mode,true);if(t.mode==="show"){if(t.commit){this.commit=t.commit}else{throw"Starting a blackhighlighter in show mode requires a commit in the options"}}else{if(t.commit){throw"Can't start a compose/protect blackhighlighter with a commit"}}if(t.reveals){this.reveals=t.reveals}if(t.protections){this.protections=t.protections}if(t.update)e.bind("update.blackhighlighter",t.update)};C._registry=[];C.getInstance=function(t){var n=e.map(C._registry,function(e){return e.$div[0]}),r=e.inArray(t,n);return r>-1?C._registry[r]:null};C.prototype={update:function(){this.$div.triggerHandler("update.blackhighlighter")},destroy:function(){var t=e.inArray(this,C._registry);if(t>-1)C._registry.splice(t,1);this.$div.unbind("update.blackhighlighter")},_addSuggestionsRecursive:function(t){function r(r){var i=e('<span class="suggested">'+r+"</span>");e(t).before(i);i.on("click",e.proxy(this._takeSuggestionListener,this));n=false}function i(r){if(n){throw"Pushed two text nodes in a row, need normalization for that."}if(r!==""){e(t).before(document.createTextNode(r));n=true}}var n=false;var s=e.type(t.nodeType)===undefined?T.ATTRIBUTE_NODE:t.nodeType;switch(s){case T.TEXT_NODE:var o=t.data;var u=t.data;var a=/[0-9a-zA-Z]+@[0-9a-zA-Z]+[\.][0-9a-zA-Z]+[\.]?[0-9a-zA-Z]+/g;var f=u.search(a);if(f==-1){break}var l=u.split(a);a.lastIndex=0;var c=u.match(a);var h=0;var p=0;if(l[0]===""){p++}while(h<c.length&&p<l.length){if(f==0){r.call(this,c[h++]);i.call(this,l[p++])}else{i.call(this,l[p++]);r.call(this,c[h++])}}if(f===0){if(h<c.length){r(c[h++])}}else{if(p<l.length){i(l[p++])}}if(p!=l.length||h!=c.length){throw"Unreachable condition in regular expression matcher for addProtectSuggestions."}e(t).remove();break;case T.ELEMENT_NODE:if(t.tagName.toLowerCase()!="span"||!e(t).hasClass("protected")){var d=t.firstChild;while(d){var v=d.nextSibling;this._addSuggestionsRecursive(d);d=v}}break;default:break}},_removeSuggestions:function(){this.$div.find("span.suggested").each(function(t,n){var r=e(n);var i=r.parent();r.replaceWith(r.contents().remove());i.get(0).normalize()})},_canonizeContent:function(){var t=function(t){return e(t).find(":not(iframe)").addBack().contents().filter(function(){return this.nodeType==T.TEXT_NODE})};t(this.$div).each(function(e,t){var n=t.nodeValue;n=n.replace(/\s+/g," ");n=n.replace(/^\s+|\s+$/g,"");t.nodeValue=n});this.$div.find("p").each(function(t,n){var r=e(n);var i=e("<div></div>");r.before(i);i.append(r.contents());r.remove()});if(!this.$div.find("div, br").length){var n=e("<div></div>").append(this.$div.contents().remove());this.$div.append(n)}if(this.$div.contents().length>=2&&!this.$div.contents().eq(0).is("div")&&this.$div.contents().eq(1).is("div")){this.$div.contents().eq(0).wrapAll("<div></div>")}this.$div.find("div").each(function(t,n){var r=e(n);if(r.contents().length==1&&r.contents().first().is("br")){r.after(e("<br>"));r.remove()}else{r.after(e("<br>"));r.before(r.contents());r.remove()}});var r=this.$div.contents();var i,s,o;s=e();if(r.length>1){for(o=0;o<r.length;o++){i=r.eq(o);if(i.is("br")){if(s.length>0){s.wrapAll("<div></div>");i.remove()}else{i.replaceWith(e('<div class="zwnj-spacing-hack">&zwnj;</div>'))}s=e()}else{s=s.add(i)}}s.wrapAll("<div></div>")}var u=[];this.$div.find("a").each(function(e){u.push(this)});e.each(u,function(t,n){var r=n.parentNode;e(n).replaceWith(e(n).contents());r.normalize();if(notNormalized(r)){throw"Normalization failure trying to fix contenteditable."}})},_decanonizeContent:function(){this.$div.children().each(function(t,n){var r=e(n);if(r.is("div")&&t==0){r.before(r.contents());r.remove()}else if(r.is("div")&&r.hasClass("zwnj-spacing-hack")){r.html(e("<br>"));r.removeClass("zwnj-spacing-hack")}})},setMode:function(t,n){function i(){this.$div.find(".placeholder.verified").css("background-color",i.isRed?"":"transparent");i.isRed=!i.isRed}var r=undefined;if(!n){r=this.mode;if(r==t){return}switch(r){case"compose":{this.$div.attr("contenteditable",false).removeClass("blackhighlighter-compose");break};case"protect":{this.$div.removeClass("blackhighlighter-protect").off("mousedown",this._inkOnListener,this).off("mouseup mouseleave",this._inkOffListener,this);this.$div.removeClass("blackhighlighter-ink");this.$div.find("span.protected").off("click",this._unprotectSpanListener);this._removeSuggestions();this._decanonizeContent();break};case"show":{this.$div.removeClass("blackhighlighter-show");break};case"reveal":{this.$div.removeClass("blackhighlighter-reveal");clearInterval(this.blinkTimer);this.$div.find(".placeholder.verified").css("background-color","");break};default:throw"Internal blackhighlighter error: bad mode found."}}i.isRed=false;switch(t){case"compose":{this.$div.attr("contenteditable",true).addClass("blackhighlighter-compose");break};case"protect":{this.$div.addClass("blackhighlighter-protect");this._canonizeContent();this.$div.find("span.protected").on("click",this._unprotectSpanListener);this.$div.on("mousedown",e.proxy(this._inkOnListener,this));this.$div.on("mouseup mouseleave",e.proxy(this._inkOffListener,this));this._addSuggestionsRecursive(this.$div.get(0));break};case"show":if(n){this.initialLetterText=this.$div.contents().clone()}else{}this.$div.addClass("blackhighlighter-show");break;case"reveal":if(r!=="show"){throw"Can only go from show to reveal."}this.$div.addClass("blackhighlighter-reveal");this.blinkTimer=setInterval(e.proxy(i,this),800);break;default:throw"Invalid mode passed to setBlackhighlighterMode: "+t}this.mode=t},_killEmptyTextNodesRecursivePreorder:function(t){var n=this;if(t.nodeType==T.TEXT_NODE&&t.data===""){e(t).remove()}else{e.each(t.childNodes,function(e,t){n._killEmptyTextNodesRecursivePreorder(t)})}},_normalizeProtectionsInSubtree:function(t){var n=[];e(t).find("span").filter(".protected").each(function(t){var r=this.nextSibling;while(r!==null&&r.nodeType==T.ELEMENT_NODE&&r.tagName.toLowerCase()=="span"&&e(r).hasClass("protected")){e(r).contents().remove().appendTo(this);this.normalize();n.push(r);r=r.nextSibling}});e.each(n,function(e,t){t.remove()})},_unprotectSpan:function(e){if(this.mode!=="protect"){throw"Can't unprotect span outside of protect mode"}if(!e.hasClass("protected")){throw"trying to unprotect a non-protected span"}var t=e.parent().get(0);e.replaceWith(e.contents().remove());t.normalize();this._killEmptyTextNodesRecursivePreorder(t)},_clearUserSelection:function(){if(window.getSelection){window.getSelection().removeAllRanges()}else if(document.selection){document.selection.empty()}},_unprotectSpanListener:function(t){var n=e(t.target);this._clearUserSelection();this._unprotectSpan(n);this.update();return true},_takeSuggestionNoNormalize:function(t){if(this.mode!=="protect"){throw"Can't take protect suggestion outside of protect mode"}if(!t.hasClass("suggested")){throw"trying to take non-suggested span"}t.removeClass("suggested");t.off("click",this._takeSuggestionListener);t.addClass("protected");t.on("click",e.proxy(this._unprotectSpanListener,this))},_takeSuggestion:function(e){var t=e.parent();this._takeSuggestionNoNormalize(e);this._normalizeProtectionsInSubtree(t)},_takeSuggestionListener:function(t){var n=e(t.target);this._clearUserSelection();this._takeSuggestion(n);this.update();return true},_makeProtectedSpan:function(t){if(!t){throw"Empty string passed to _makeProtectedSpan"}var n=e('<span class="protected">'+t+"</span>");if(this.mode==="protect"){n.on("click",e.proxy(this._unprotectSpanListener,this))}return n},_inkOnListener:function(e){var t=this;this.$div.addClass("blackhighlighter-ink");return true},_protectRangeIfApplicable:function(t){function a(e){var t=e.get(0);var n=0;while(t=t.previousSibling){n++}return n}function f(t,r){var i=e(r);if(r.nodeType===T.TEXT_NODE){i.replaceWith(n._makeProtectedSpan(r.nodeValue))}else if(i.is("span")){if(i.hasClass("protected")){}else if(i.hasClass("suggested")){n._takeSuggestionNoNormalize(i)}}else{throw"Unknown element found in blackhighlighter."}}var n=this;if(!this.$div.get(0).contains(t.commonAncestorContainer)){return false}var r=e(t.startContainer);var i=r;var s=e(t.endContainer);var o=s;if(i.get(0).nodeType===T.TEXT_NODE){i=i.parent();if(i.is("span")){i=i.parent()}}if(o.get(0).nodeType===T.TEXT_NODE){o=o.parent();if(o.is("span")){o=o.parent()}}if(!i.is("div")){throw Error("Blackhiglighter sel doesn't start in a div")}if(!o.is("div")){throw Error("Blackhiglighter sel doesn't end in a div")}if(!i.parent().is(o.parent())){throw Error("Blackhighlighter start/end different parents")}if(!i.parent().is(this.$div)){throw Error("Selection isn't normalized inside container")}var u=false;i.nextAll().add(i).each(function(t,n){var r=e(n);if(r.is(o)){u=true;return false}});if(!u){throw Error("Illegal enumeration in blackhighlighter area.")}this._clearUserSelection();var l=t.startOffset;var c=t.endOffset;if(r.parent().hasClass("zwnj-spacing-hack")){r=r.parent()}while(r.hasClass("zwnj-spacing-hack")){if(r.is(s)){return false}r=r.next();l=0}if(s.parent().hasClass("zwnj-spacing-hack")){s=s.parent()}while(s.hasClass("zwnj-spacing-hack")){if(s.is(r)){throw"Internal error in zwnj-spacing-hack enumeration"}s=s.prev();c=s.contents().length}var h=r.parent();var p=s.parent();if(r.is(s)&&r.get(0).nodeType===T.TEXT_NODE){if(h.is("span")){if(h.hasClass("protected")){console.error("Note: redacting inside redaction");return false}else if(h.hasClass("suggested")){console.error("Note: redacting inside suggestion");h.replaceWith(h.contents().remove())}else{throw"Unknown span selection in blackhighlighter"}}var d=r.get(0).nodeValue;var v=this._makeProtectedSpan(d.substring(l,c));var m=document.createTextNode(d.substr(c));r.get(0).nodeValue=d.slice(0,l);r.after(v);v.after(m)}else{if(r.get(0).nodeType===T.TEXT_NODE){if(h.is("span")&&h.hasClass("protected")){l=a(r);r=r.parent()}else{if(h.is("span")){if(h.hasClass("suggested")){h.replaceWith(h.contents().remove())}else{throw"Unknown span selection in blackhighlighter"}}var g=r.get(0).nodeValue;var y=this._makeProtectedSpan(g.substr(l));r.get(0).nodeValue=g.slice(0,l);r.after(y);r=y;if(r.parent().is(s)){c++}}l=a(r);r=r.parent()}if(s.get(0).nodeType===T.TEXT_NODE){if(p.is("span")&&p.hasClass("protected")){c=a(s);s=s.parent()}else{if(p.is("span")){if(p.hasClass("suggested")){p.replaceWith(p.contents().remove())}else{throw"Unknown span selection in blackhighlighter"}}var b=s.get(0).nodeValue;var w=this._makeProtectedSpan(b.slice(0,c));s.get(0).nodeValue=b.substr(c);s.before(w);s=w}c=a(s);s=s.parent()}if(!r.parent().is(s.parent())){throw Error("Assertion failed: startContainer != endContainer")}if(r.is(s)){r.contents().slice(l,c).each(f)}else{r.contents().slice(l).each(f);s.contents().slice(0,c).each(f);r.nextUntil(s).each(function(t,n){var r=e(n);if(!r.hasClass("zwnj-spacing-hack")){e(n).contents().each(f)}})}}this.$div.find("div").each(function(e,t){t.normalize()});this._killEmptyTextNodesRecursivePreorder(this.$div);this._normalizeProtectionsInSubtree(this.$div);this._clearUserSelection();this.update();return true},_inkOffListener:function(e){var t=e.target;this.$div.removeClass("blackhighlighter-ink");var n=window.getSelection();for(var r=0;r<n.rangeCount;r++){var i=n.getRangeAt(r);if(!i){throw"Empty range received from selection model"}if(!i.toString()){}else{this._protectRangeIfApplicable(i)}}return true},generateCommitAndProtections:function(){function a(t){function f(t){if(e.type(t)!=="string"){throw"Pushing non-string as string span"}if(t.length===0){throw"Pushing zero length string span"}c();var r=n.spans.length;if(r>0&&e.type(n.spans[r-1])==="string"){n.spans[r-1]+=t}else{n.spans.push(t)}}function l(t){if(e.type(t.display_length)===undefined){throw"Invalid placeholder pushed"}c();n.spans.push(t)}function c(){if(o){o=false;f("\n")}}function h(){o=true}function p(){o=false;f("\n")}function d(e){return"black"}var r=e(t);if(t.nodeType===T.TEXT_NODE){f.call(this,t.data);return}if(t.nodeType!==T.ELEMENT_NODE){throw"Unexpected nodeType in canonized blackhighlighter area"}if(r.is("span")){if(e(t).hasClass("protected")){var v=r.text();if(v.length===0){throw"Zero length redaction found, illegal"}var m=d(t);var g=i[m];if(e.type(g)==="undefined"){g={redactions:[],name:m};i[m]=g}var y={display_length:v.length};s.push({obj:y,protection:g,order:u});g.redactions.push(v);u++;l.call(this,y)}else if(r.hasClass("suggested")){f.call(this,r.text())}else{throw"Illegal span found in canonized blackhighlighter area"}}else if(r.is("div")){if(e(t).hasClass("zwnj-spacing-hack")){p.call()}else{e(t).contents().each(function(e){a(this)});p.call()}}else{throw"Unknown DOM element found in blackhighlighter canonized area"}}var t=this.mode;this.setMode("protect");var n={spans:[]};var r=undefined;var i={};var s=[];var o=false;var u=1;this.$div.contents().each(function(e){a(this)});var f={};for(var l in i){if(i.hasOwnProperty(l)){var c=i[l];var h=N.stripHyphensFromUUID(N.generateRandomUUID());var p=h;e.each(c.redactions,function(e,t){p+=t});c.salt=h;c.sha256=E(p);f[c.sha256]=c}}e.each(s,function(e,t){var n=t.obj;var r=t.protection;var i=t.order;n.sha256=r.sha256});var d=false;e.each(n.spans,function(t,n){if(e.type(n)==="string"){if(d){throw"Two sequential string spans in commit -- error in generateCommitAndProtections()"}d=true}else{d=false}});if(n.spans.length===0){n=null}else if(n.spans.length===1){if(e.type(n.spans[0])==="string"&&N.trimAllWhitespace(n.spans[0])===""){n=null}}this.setMode(t);return{commit:n,protections:f}},makeCommitment:function(t,n){var r=this.generateCommitAndProtections();var i=this;e.ajax({type:"POST",dataType:"json",url:N.makeCommitUrl(t),data:{commit:N.escapeNonBreakingSpacesInString(JSON.stringify(r.commit,null," "))},success:function(t){if(t.error){notifyErrorOnTab("commit",t.error.msg)}else{r.commit.commit_date=t.commit.commit_date;r.commit.commit_id=E(N.canonicalJsonFromCommit(r.commit));if(r.commit.commit_id!=t.commit.commit_id){n("Server accepted data but did not calculate same commit hash we did!",null)}e.each(r.protections,function(e,t){t.commit_id=r.commit.commit_id});i.commit=r.commit;i.protections=r.protections;i.$div.html("<h3>Comitting Blackhighlighter Message to Server</h3>"+"<p><i>Please wait...</i></p>");i.setMode("show");n(null)}},error:function(e,t,r){switch(t){case"timeout":n("The request timed out.  Check your network connection and try again.",null);break;case"error":n("There was an error on the server side during your request.",null);break;case"notmodified":case"parsererror":n("commit","Unexpected error code during Ajax POST: "+t,null);break;default:n("Unexpected error code during Ajax POST: "+t,null);break}}})},_refreshAllPlaceholders:function(){var t={};this.$div.empty().append(this.initialLetterText.clone());var n=this;this.$div.find("span").filter(".placeholder").each(function(r){var i=e(this);var s=i.attr("title");if(!i.hasClass("revealed")){var o=true;var u=n.reveals[s];if(!u){o=false;u=n.protections[s]}if(u){if(!t[s]){t[s]=0}i.text(u.redactions[t[s]]);t[s]++;i.removeClass("protected");if(o){i.addClass("revealed")}else{i.addClass("verified")}}}})},seeProtection:function(t,n){var r=E(N.canonicalStringFromReveal(t));if(r!=t.sha256){throw"Invalid certificate: content hash is "+r+" while claimed hash is "+t.sha256}var i=0;e.each(this.commit.spans,function(e,n){if(n.sha256==t.sha256){i++}});if(i===0){throw"Certificate does not match any placeholders."}if(i!=t.redactions.length){throw"Certificate contains "+t.redactions.length+" redactions for key when letter needs "+i+" for that key"}if(n){this.reveals[t.sha256]=t}else{if(t.sha256 in this.reveals){throw"Local certificate already revealed on server."}else if(t.sha256 in this.protections){throw"You have already revealed the local certificate."}else{this.protections[t.sha256]=t}}this._refreshAllPlaceholders()},unseeProtection:function(e){if(!(e in this.protections)){throw"Attempt to remove certificate that is not in the local list."}delete this.protections[protctionKey];this._refreshAllPlaceholders()},revealSecret:function(t,n){var r=[];e.each(this.protections,function(e,t){r.push(t)});if(r.length!=1){throw"Multiple reveals feature not currently supported by client"}var i=N.makeRevealUrl(PARAMS.base_url);e.ajax({type:"POST",dataType:"json",url:i,data:{reveal:JSON.stringify(r[0],null," ")},success:function(e){if(e.error){n(e.error.msg)}else{n(null)}},error:function(e,t,r){switch(t){case"timeout":n("The POST reveal request timed out on "+i+" --- check your network connection and try again.");break;case"error":n("There was an error with the web server during your request.");break;case"notmodified":case"parsererror":notifyErrorOnTab("Unexpected error code during Ajax POST: "+t);break;default:notifyErrorOnTab("Unexpected error code during Ajax POST: "+t);break}}})}};e.blackhighlighter=e.extend({autoInitialize:true,initialSelector:"div.blackhighlighter",opts:{mode:"compose",commit:null,protections:{},reveals:{},update:function(){}}},e.blackhighlighter||{});e.fn.blackhighlighter=function(t,n,i){if(t==="option"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in blackhighlighter options.")}var a=C.getInstance(this.get(0));if(n==="mode"){if(!a)return undefined;if(e.type(i)==="undefined"){return a.mode}else{a.setMode(i);return undefined}}if(n==="commit"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections for commit.")}var a=C.getInstance(this.get(0));if(a.mode==="show"||a.mode==="reveal"){return e.extend(true,{},a.commit)}else{var f=a.generateCommitAndProtections();return f.commit}}if(n==="protections"){if(!a)return undefined;if(a.mode==="show"||a.mode==="reveal"){return e.extend(true,{},a.protections)}else{var f=a.generateCommitAndProtections();return f.protections}}if(n==="reveals"){if(!a)return undefined;if(a.mode==="show"||a.mode==="reveal"){return e.extend(true,{},a.reveals)}else{return{}}}throw"Unknown option passed to blackhighlighter"}if(t==="certificate"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in certificate.")}var a=C.getInstance(this.get(0));if(!a)return undefined;if(a.mode==="show"||a.mode==="reveal"){if(n==="encode"){if(e.type(i)!=="object"){throw"Parameter to certificate encode must be object"}var l=N.escapeNonBreakingSpacesInString(JSON.stringify(i,null," "));var c=u(l);var h=s(c);h.replace(/(.{60})/g,"$1\n");return h}else if(n==="decode"){if(e.type(i)!=="string"){throw"Parameter to certificate decode must be string"}var p=i.replace(/\s/g,"");var d=r(p);var v=o(d);var m=null;var g=JSON.parse(v);if(e.type(g)!=="array"){m=[g]}else{m=g}return m}else{throw"Option to certificate other than encode/decode"}return a.reveals.clone()}else{throw"Can't encode or decode certificates while editing/protecting"}}if(t==="ismodified"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in debuginfo.")}var a=C.getInstance(this.get(0));if(a.mode==="show"||a.mode==="reveal"){return false}else{var f=a.generateCommitAndProtections();return f.commit!==null}}if(t==="makecommitment"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in commit.")}var a=C.getInstance(this.get(0));a.makeCommitment(n,i)}if(t==="seereveal"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in commit.")}var a=C.getInstance(this.get(0));return a.seeProtection(n,i)}if(t==="revealsecret"){if(this.length!=1){throw new Error("Currently not handling length > 1 collections in commit.")}var a=C.getInstance(this.get(0));a.revealSecret(n,i)}if(t==="destroy"){this.each(function(){var e=C.getInstance(this);if(e)e.destroy()});return this}if(t==="active"){return!!this.filter(function(){return!!C.getInstance(this)}).length}var y=e.extend({},e.blackhighlighter.opts,t);this.filter("div").each(function(){var t=C.getInstance(this);if(!t)new C(e(this),y);else{if(t)k("Blackhighlighter: attempt to initialize a div that has already been initialized. Subsequent calls are ignored.")}});return this};e(function(){if(e.blackhighlighter.autoInitialize){e(e.blackhighlighter.initialSelector).blackhighlighter()}e(document).on("paste",function(t){var n=e(document.activeElement);if(!n.hasClass("blackhighlighter")){return true}var r=undefined;if(window.clipboardData&&window.clipboardData.getData){r=window.clipboardData.getData("Text")}else if(t.originalEvent.clipboardData&&t.originalEvent.clipboardData.getData){r=t.originalEvent.clipboardData.getData("text/plain")}var i=x(r);var s=new RegExp("\n","g");i=i.replace(s,"<br>");s=new RegExp("  ","g");i=i.replace(s,"&nbsp;&nbsp;");s=new RegExp("&nbsp; ","g");i=i.replace(s,"&nbsp;&nbsp;");document.execCommand("insertHtml",false,i);t.preventDefault();return false})});return N})